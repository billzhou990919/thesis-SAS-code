/*current dataset is called mscan.final_continuous_enrollment*/
proc sql;
    create table mscan.overlap_period_final as
    select * from mscan.overlap_period_3
    where enrolid in (select enrolid from mscan.final_continuous_enrollment);
quit;

data enrolid_sex;
    set mscan.all_enrollment;
    by enrolid;
    if first.enrolid;
    keep enrolid sex;
run;

proc sql;
    create table mscan.analytical_cohort as
    select a.*, b.sex
    from mscan.final_continuous_enrollment as a
    left join enrolid_sex as b
    on a.enrolid = b.enrolid;
    keep enrolid day0 sex;
quit;


/* Merge datasets and filter based on the condition */
data mscan.filtered_doac;
    merge mscan.common_doac (in=a)
          mscan.analytical_cohort (in=b);
    by enrolid;
    if a and b and enddate_doac > day0;
Run;

data mscan.filtered_statin;
    merge mscan.common_statin (in=a)
          mscan.analytical_cohort (in=b);
    by enrolid;
    if a and b and enddate_statin > day0;
Run;


/*get rid of gap > 30 days between drug dispensing*/

proc sort data=mscan.filtered_doac; 
    by enrolid svcdate_doac;
run;

/* Check for gaps greater than 30 days and delete such records */
data mscan.doac_no_gap;
    set mscan.filtered_doac;
    by enrolid;
    
    retain prev_enddate;
    
    if first.enrolid then do;
        prev_enddate = enddate_doac;
    end;
    else do;
        if svcdate_doac - prev_enddate > 30 then delete;
        prev_enddate = enddate_doac;
    end;
    
run;

proc sort data=mscan.filtered_statin; 
    by enrolid svcdate_statin;
run;

/* Check for gaps greater than 30 days and delete such records */
data mscan.statin_no_gap;
    set mscan.filtered_statin;
    by enrolid;
    
    retain prev_enddate;
    
    if first.enrolid then do;
        prev_enddate = enddate_statin;
    end;
    else do;
        if svcdate_statin - prev_enddate > 30 then delete;
        prev_enddate = enddate_statin;
    end;
    
run;


/*find overlaps periods*/
data mscan.common_all_2;
    merge mscan.doac_no_gap (in=a rename=(svcdate=svcdate_doac drugname=doac_name))
          mscan.statin_no_gap(in=b rename=(svcdate=svcdate_statin drugname=statin_name));
    by enrolid;
    if a and b;
run;

data mscan.concomitant_use;
    set mscan.common_all_2;
    by enrolid;

    /* Check for overlapping periods */
    if ( (svcdate_doac <= enddate_statin and svcdate_doac >= svcdate_statin) or 
         (enddate_doac >= svcdate_statin and enddate_doac <= enddate_statin) or 
         (svcdate_doac >= svcdate_statin and enddate_doac <= enddate_statin) or 
         (svcdate_doac <= svcdate_statin and enddate_doac >= enddate_statin) ) ;

    /* Determine the overlap period */
    overlap_start = max(svcdate_doac, svcdate_statin);
    overlap_end = min(enddate_doac, enddate_statin);

    /* Include any additional variables or calculations as needed */
    
    keep enrolid overlap_start overlap_end doac_name statin_name; 
run;
